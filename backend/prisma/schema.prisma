// This is your Prisma schema file
datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// Enums
enum UserRole {
  OWNER
  SHOP
  ADMIN
}

enum ShopPayoutSchedule {
  WEEKLY
  BIWEEKLY
  MONTHLY
  MANUAL
}

enum DayOfWeek {
  MON
  TUE
  WED
  THU
  FRI
  SAT
  SUN
}

enum ServiceCategory {
  MAINTENANCE
  REPAIR
  DIAGNOSTIC
}

enum CarType {
  COMPACT
  SEDAN
  SUV
  LUXURY
  EV
}

enum QuoteStatus {
  PENDING
  QUOTED
  ACCEPTED
  REJECTED
  EXPIRED
}

enum QuoteItemType {
  PART
  LABOR
  FEE
}

enum BookingMethod {
  DROP_OFF
  WAIT
  MOBILE
}

enum BookingStatus {
  PENDING
  CONFIRMED
  IN_PROGRESS
  WAITING_PARTS
  COMPLETED
  CANCELLED
}

enum JobStatus {
  RECEIVED
  INSPECTING
  IN_PROGRESS
  WAITING_PARTS
  TESTING
  COMPLETED
}

enum InvoiceStatus {
  PENDING
  APPROVED
  DISPUTED
  PAID
}

enum InvoiceItemType {
  PART
  LABOR
  FEE
  DISCOUNT
}

enum PaymentType {
  DEPOSIT
  FINAL
  REFUND
}

enum PaymentMethodType {
  CARD
  APPLE_PAY
  PAYPAL
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

enum DisputeStatus {
  OPEN
  UNDER_REVIEW
  RESOLVED
  CLOSED
}

enum DisputeRecipientType {
  USER
  SHOP
  BOTH
}

enum ForumCategory {
  QUESTION
  TIP
  DISCUSSION
  ANNOUNCEMENT
}

enum NotificationType {
  BOOKING
  QUOTE
  MESSAGE
  REVIEW
  PAYMENT
  SYSTEM
}

// Models
model User {
  id               Int       @id @default(autoincrement())
  email            String    @unique
  passwordHash     String    @map("password_hash")
  name             String
  phone            String?
  avatarUrl        String?   @map("avatar_url")
  role             UserRole  @default(OWNER)
  emailVerified    Boolean   @default(false) @map("email_verified")
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")
  resetToken       String?   @map("reset_token")
  resetTokenExpiry DateTime? @map("reset_token_expiry")

  // Relations
  vehicles         Vehicle[]
  shop             Shop? // Only if role is SHOP
  bookings         Booking[]
  reviews          Review[]
  sentMessages     Message[]
  forumPosts       ForumPost[]
  postLikes        PostLike[]
  comments         Comment[]
  notifications    Notification[]
  paymentMethods   PaymentMethod[]
  payments         Payment[]
  createdUpdates   JobUpdate[]
  sentDisputeMsgs  DisputeMessage[]
  resolvedDisputes Dispute[]        @relation("ResolvedDisputes")
  disputes         Dispute[]        @relation("UserDisputes")
  Quote            Quote[]
  conversations1   Conversation[]   @relation("c1")
  conversations2   Conversation[]   @relation("c2")
  QuoteRequest     QuoteRequest[]

  isOnline         Boolean          @default(false) @map("is_online")
  lastActive       DateTime         @default(now()) @map("last_active")

  @@index([email])
  @@index([role])
  @@map("users")
}

model Shop {
  id             Int                @id @default(autoincrement())
  userId         Int                @unique @map("user_id")
  name           String
  description    String?            @db.Text
  address        String             @map("address")
  city           String?
  state          String?
  zipCode        String?            @map("zip_code")
  latitude       Decimal?           @db.Decimal(10, 8)
  longitude      Decimal?           @db.Decimal(11, 8)
  phone          String?
  email          String?
  website        String?
  imageUrl       String?            @map("image_url")
  rating         Decimal            @default(0.0) @db.Decimal(2, 1)
  reviewCount    Int                @default(0) @map("review_count")
  verified       Boolean            @default(false)
  verifiedAt     DateTime?          @map("verified_at")
  laborRate      Decimal?           @map("labor_rate") @db.Decimal(10, 2)
  partsMarkup    Decimal            @default(15.00) @map("parts_markup") @db.Decimal(5, 2)
  depositPercent Int                @default(25) @map("deposit_percent")
  warrantyDays   Int                @default(30) @map("warranty_days")
  bankLast4      String?            @map("bank_account_last4")
  payoutSchedule ShopPayoutSchedule @default(WEEKLY) @map("payout_schedule")
  isActive       Boolean            @default(true) @map("is_active")
  createdAt      DateTime           @default(now()) @map("created_at")
  updatedAt      DateTime           @updatedAt @map("updated_at")

  // Relations
  user           User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  hours          ShopHour[]
  certifications ShopCertification[]
  services       ShopService[]
  bookings       Booking[]
  quotes         Quote[]
  reviews        Review[]
  conversations  Conversation[]      @relation("ShopConversations")
  comments       Comment[]
  disputes       Dispute[]

  @@index([verified])
  @@index([latitude, longitude])
  @@index([rating(sort: Desc)])
  @@map("shops")
}

model ShopHour {
  id        Int       @id @default(autoincrement())
  shopId    Int       @map("shop_id")
  day       DayOfWeek @map("day_of_week")
  openTime  DateTime? @map("open_time") @db.Time
  closeTime DateTime? @map("close_time") @db.Time
  isClosed  Boolean   @default(false) @map("is_closed")

  shop Shop @relation(fields: [shopId], references: [id], onDelete: Cascade)

  @@unique([shopId, day])
  @@map("shop_hours")
}

model ShopCertification {
  id                Int       @id @default(autoincrement())
  shopId            Int       @map("shop_id")
  name              String
  issuingAuthority  String?   @map("issuing_authority")
  certificateNumber String?   @map("certificate_number")
  issuedDate        DateTime? @map("issued_date") @db.Date
  expiryDate        DateTime? @map("expiry_date") @db.Date
  documentUrl       String?   @map("document_url")
  verified          Boolean   @default(false)
  createdAt         DateTime  @default(now()) @map("created_at")

  shop Shop @relation(fields: [shopId], references: [id], onDelete: Cascade)

  @@map("shop_certifications")
}

model Service {
  id          Int             @id @default(autoincrement())
  name        String
  description String?         @db.Text
  category    ServiceCategory
  durationEst Int?            @map("estimated_duration_minutes")
  warranty    String?         @map("warranty_info")
  includes    Json?
  isActive    Boolean         @default(true) @map("is_active")
  createdAt   DateTime        @default(now()) @map("created_at")

  // Relations
  pricing      ServicePricing[]
  shopServices ShopService[]
  bookings     Booking[]
  quotes       Quote[]

  @@index([category])
  @@map("services")
}

model ServicePricing {
  id          Int     @id @default(autoincrement())
  serviceId   Int     @map("service_id")
  vehicleType CarType @map("vehicle_type")
  minPrice    Decimal @map("min_price") @db.Decimal(10, 2)
  maxPrice    Decimal @map("max_price") @db.Decimal(10, 2)

  service Service @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  @@unique([serviceId, vehicleType])
  @@map("service_pricing")
}

model DiagnosticPackage {
  id          Int      @id @default(autoincrement())
  name        String
  description String?  @db.Text
  price       Decimal  @db.Decimal(10, 2)
  duration    String
  includes    Json?    // Array of strings
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")

  @@map("diagnostic_packages")
}

model ShopService {
  id             Int      @id @default(autoincrement())
  shopId         Int      @map("shop_id")
  serviceId      Int      @map("service_id")
  customPrice    Decimal? @map("custom_price") @db.Decimal(10, 2)
  customDuration Int?     @map("custom_duration_minutes")
  isAvailable    Boolean  @default(true) @map("is_available")

  shop    Shop    @relation(fields: [shopId], references: [id], onDelete: Cascade)
  service Service @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  @@unique([shopId, serviceId])
  @@map("shop_services")
}

model Vehicle {
  id           Int      @id @default(autoincrement())
  userId       Int      @map("user_id")
  vin          String?
  make         String
  model        String
  year         Int
  type         CarType
  trim         String?
  licensePlate String?  @map("license_plate")
  color        String?
  mileage      Int?
  imageUrl     String?  @map("image_url")
  isPrimary    Boolean  @default(false) @map("is_primary")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  user         User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  bookings     Booking[]
  quotes       Quote[]
  QuoteRequest QuoteRequest[]

  @@index([userId])
  @@index([vin])
  @@map("vehicles")
}

enum QuoteRequestStatus {
  OPEN
  CLOSED
  EXPIRED
}

model QuoteRequest {
  id            Int                @id @default(autoincrement())
  userId        Int                @map("user_id")
  vehicleId     Int                @map("vehicle_id")
  description   String             @db.Text
  symptoms      Json? // Array of strings
  photos        Json? // Array of strings (urls)
  status        QuoteRequestStatus @default(OPEN)
  broadcast     Boolean            @default(true)
  radius        Int                @default(10)
  targetShopIds Json? // Array of shop IDs if not broadcast
  createdAt     DateTime           @default(now()) @map("created_at")
  updatedAt     DateTime           @updatedAt @map("updated_at")

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  vehicle Vehicle @relation(fields: [vehicleId], references: [id], onDelete: Cascade)
  quotes  Quote[]

  @@index([userId])
  @@index([status])
  @@map("quote_requests")
}

model Quote {
  id              Int         @id @default(autoincrement())
  userId          Int         @map("user_id")
  shopId          Int         @map("shop_id")
  vehicleId       Int         @map("vehicle_id")
  serviceId       Int?        @map("service_id")
  quoteRequestId  Int?        @map("quote_request_id")
  status          QuoteStatus @default(PENDING)
  description     String?     @db.Text
  photoUrls       Json?       @map("photo_urls")
  aiDiagnosis     String?     @map("ai_diagnosis") @db.Text
  confidenceScore Decimal?    @map("confidence_score") @db.Decimal(3, 2)
  partsEstimate   Decimal?    @map("parts_estimate") @db.Decimal(10, 2)
  laborEstimate   Decimal?    @map("labor_estimate") @db.Decimal(10, 2)
  totalEstimate   Decimal?    @map("total_estimate") @db.Decimal(10, 2)
  validUntil      DateTime?   @map("valid_until")
  createdAt       DateTime    @default(now()) @map("created_at")
  updatedAt       DateTime    @updatedAt @map("updated_at")

  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  shop         Shop          @relation(fields: [shopId], references: [id], onDelete: Cascade)
  vehicle      Vehicle       @relation(fields: [vehicleId], references: [id])
  service      Service?      @relation(fields: [serviceId], references: [id])
  quoteRequest QuoteRequest? @relation(fields: [quoteRequestId], references: [id])
  items        QuoteItem[]
  booking      Booking?

  @@index([status])
  @@index([shopId])
  @@index([userId])
  @@index([quoteRequestId])
  @@map("quotes")
}

model QuoteItem {
  id          Int           @id @default(autoincrement())
  quoteId     Int           @map("quote_id")
  description String
  type        QuoteItemType @map("item_type")
  quantity    Int           @default(1)
  unitPrice   Decimal       @map("unit_price") @db.Decimal(10, 2)
  totalPrice  Decimal       @map("total_price") @db.Decimal(10, 2)

  quote Quote @relation(fields: [quoteId], references: [id], onDelete: Cascade)

  @@map("quote_line_items")
}

model Booking {
  id             Int           @id @default(autoincrement())
  userId         Int           @map("user_id")
  shopId         Int           @map("shop_id")
  vehicleId      Int           @map("vehicle_id")
  serviceId      Int?          @map("service_id")
  quoteId        Int?          @unique @map("quote_id")
  scheduledDate  DateTime      @map("scheduled_date") @db.Date
  scheduledTime  DateTime      @map("scheduled_time") @db.Time
  method         BookingMethod @default(DROP_OFF) @map("booking_method")
  pickupAddress  String?       @map("pickup_address")
  status         BookingStatus @default(PENDING)
  estimatedTotal Decimal?      @map("estimated_total") @db.Decimal(10, 2)
  depositAmount  Decimal?      @map("deposit_amount") @db.Decimal(10, 2)
  depositPaid    Boolean       @default(false) @map("deposit_paid")
  notes          String?       @db.Text
  createdAt      DateTime      @default(now()) @map("created_at")
  updatedAt      DateTime      @updatedAt @map("updated_at")

  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  shop         Shop          @relation(fields: [shopId], references: [id], onDelete: Cascade)
  vehicle      Vehicle       @relation(fields: [vehicleId], references: [id])
  service      Service?      @relation(fields: [serviceId], references: [id])
  quote        Quote?        @relation(fields: [quoteId], references: [id])
  updates      JobUpdate[]
  invoice      Invoice?
  payments     Payment[]
  reviews      Review[]
  disputes     Dispute[]
  conversation Conversation? @relation("BookingConversation")

  @@index([status])
  @@index([scheduledDate])
  @@index([shopId])
  @@index([userId])
  @@map("bookings")
}

model JobUpdate {
  id        Int       @id @default(autoincrement())
  bookingId Int       @map("booking_id")
  status    JobStatus
  message   String?   @db.Text
  photoUrls Json?     @map("photo_urls")
  createdBy Int       @map("created_by")
  createdAt DateTime  @default(now()) @map("created_at")

  booking Booking @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  author  User    @relation(fields: [createdBy], references: [id], onDelete: Cascade)

  @@index([bookingId])
  @@map("job_updates")
}

model Invoice {
  id             Int           @id @default(autoincrement())
  bookingId      Int           @unique @map("booking_id")
  invoiceNumber  String        @unique @map("invoice_number")
  subtotal       Decimal       @db.Decimal(10, 2)
  taxAmount      Decimal       @default(0) @map("tax_amount") @db.Decimal(10, 2)
  discountAmount Decimal       @default(0) @map("discount_amount") @db.Decimal(10, 2)
  totalAmount    Decimal       @map("total_amount") @db.Decimal(10, 2)
  depositApplied Decimal       @default(0) @map("deposit_applied") @db.Decimal(10, 2)
  amountDue      Decimal       @map("amount_due") @db.Decimal(10, 2)
  status         InvoiceStatus @default(PENDING)
  approvedAt     DateTime?     @map("approved_at")
  paidAt         DateTime?     @map("paid_at")
  createdAt      DateTime      @default(now()) @map("created_at")

  booking  Booking       @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  items    InvoiceItem[]
  payments Payment[]

  @@map("invoices")
}

model InvoiceItem {
  id          Int             @id @default(autoincrement())
  invoiceId   Int             @map("invoice_id")
  description String
  type        InvoiceItemType @map("item_type")
  quantity    Int             @default(1)
  unitPrice   Decimal         @map("unit_price") @db.Decimal(10, 2)
  totalPrice  Decimal         @map("total_price") @db.Decimal(10, 2)
  photoUrl    String?         @map("photo_url")

  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@map("invoice_line_items")
}

model Payment {
  id              Int               @id @default(autoincrement())
  userId          Int               @map("user_id")
  bookingId       Int?              @map("booking_id")
  invoiceId       Int?              @map("invoice_id")
  type            PaymentType       @map("payment_type")
  amount          Decimal           @db.Decimal(10, 2)
  method          PaymentMethodType @map("payment_method")
  stripePaymentId String?           @map("stripe_payment_id")
  status          PaymentStatus     @default(PENDING)
  createdAt       DateTime          @default(now()) @map("created_at")

  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  booking Booking? @relation(fields: [bookingId], references: [id])
  invoice Invoice? @relation(fields: [invoiceId], references: [id])

  @@index([status])
  @@index([userId])
  @@map("payments")
}

model PaymentMethod {
  id        Int               @id @default(autoincrement())
  userId    Int               @map("user_id")
  type      PaymentMethodType
  stripeId  String?           @map("stripe_payment_method_id")
  cardBrand String?           @map("card_brand")
  cardLast4 String?           @map("card_last4")
  expMonth  Int?              @map("card_exp_month")
  expYear   Int?              @map("card_exp_year")
  isDefault Boolean           @default(false) @map("is_default")
  createdAt DateTime          @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("payment_methods")
}

model Review {
  id              Int       @id @default(autoincrement())
  userId          Int       @map("user_id")
  shopId          Int       @map("shop_id")
  bookingId       Int?      @map("booking_id")
  rating          Int
  comment         String?   @db.Text
  images          Json?     @default("[]")
  shopResponse    String?   @map("shop_response") @db.Text
  shopRespondedAt DateTime? @map("shop_responded_at")
  isVerified      Boolean   @default(false) @map("is_verified")
  createdAt       DateTime  @default(now()) @map("created_at")

  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  shop    Shop     @relation(fields: [shopId], references: [id], onDelete: Cascade)
  booking Booking? @relation(fields: [bookingId], references: [id])

  @@index([shopId])
  @@index([rating])
  @@map("reviews")
}

model Conversation {
  id            Int       @id @default(autoincrement())
  user1Id       Int       @map("user1_id")
  user2Id       Int       @map("user2_id")
  shopId        Int?      @map("shop_id")
  bookingId     Int?      @unique @map("booking_id")
  lastMessageAt DateTime? @map("last_message_at")
  createdAt     DateTime  @default(now()) @map("created_at")

  user1    User      @relation("c1", fields: [user1Id], references: [id], onDelete: Cascade)
  user2    User      @relation("c2", fields: [user2Id], references: [id], onDelete: Cascade)
  shop     Shop?     @relation("ShopConversations", fields: [shopId], references: [id], onDelete: Cascade)
  booking  Booking?  @relation("BookingConversation", fields: [bookingId], references: [id])
  messages Message[]

  @@unique([user1Id, user2Id])
  @@map("conversations")
}

model Message {
  id             Int      @id @default(autoincrement())
  conversationId Int      @map("conversation_id")
  senderId       Int      @map("sender_id")
  message        String   @db.Text
  attachmentUrl  String?  @map("attachment_url")
  isRead         Boolean  @default(false) @map("is_read")
  createdAt      DateTime @default(now()) @map("created_at")

  sender       User         @relation(fields: [senderId], references: [id], onDelete: Cascade)
  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([createdAt])
  @@map("messages")
}

model Dispute {
  id                 Int           @id @default(autoincrement())
  bookingId          Int           @map("booking_id")
  userId             Int           @map("user_id")
  shopId             Int           @map("shop_id")
  reason             String        @db.Text
  expectedResolution String?       @map("expected_resolution") @db.Text
  status             DisputeStatus @default(OPEN)
  resolution         String?       @db.Text
  resolvedById       Int?          @map("resolved_by")
  resolvedAt         DateTime?     @map("resolved_at")
  createdAt          DateTime      @default(now()) @map("created_at")

  booking    Booking          @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  user       User             @relation("UserDisputes", fields: [userId], references: [id], onDelete: Cascade)
  shop       Shop             @relation(fields: [shopId], references: [id], onDelete: Cascade)
  resolvedBy User?            @relation("ResolvedDisputes", fields: [resolvedById], references: [id])
  messages   DisputeMessage[]

  @@index([status])
  @@map("disputes")
}

model DisputeMessage {
  id            Int                  @id @default(autoincrement())
  disputeId     Int                  @map("dispute_id")
  senderId      Int                  @map("sender_id")
  recipientType DisputeRecipientType @map("recipient_type")
  message       String               @db.Text
  createdAt     DateTime             @default(now()) @map("created_at")

  dispute Dispute @relation(fields: [disputeId], references: [id], onDelete: Cascade)
  sender  User    @relation(fields: [senderId], references: [id], onDelete: Cascade)

  @@map("dispute_messages")
}

model ForumPost {
  id           Int           @id @default(autoincrement())
  userId       Int           @map("user_id")
  title        String
  content      String        @db.Text
  category     ForumCategory @default(DISCUSSION)
  tags         Json?
  images       Json?         // Array of strings (urls)
  video        String?       // URL to video
  viewCount    Int           @default(0) @map("view_count")
  likeCount    Int           @default(0) @map("like_count")
  commentCount Int           @default(0) @map("comment_count")
  isEdited     Boolean       @default(false) @map("is_edited")
  isPinned     Boolean       @default(false) @map("is_pinned")
  isLocked     Boolean       @default(false) @map("is_locked")
  createdAt    DateTime      @default(now()) @map("created_at")
  updatedAt    DateTime      @updatedAt @map("updated_at")

  author   User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  comments Comment[]
  likes    PostLike[]

  @@index([category])
  @@index([createdAt(sort: Desc)])
  @@map("forum_posts")
}

model PostLike {
  id        Int      @id @default(autoincrement())
  postId    Int      @map("post_id")
  userId    Int      @map("user_id")
  createdAt DateTime @default(now()) @map("created_at")

  post ForumPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  user User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([postId, userId])
  @@map("post_likes")
}

model Comment {
  id           Int      @id @default(autoincrement())
  postId       Int      @map("post_id")
  userId       Int      @map("user_id")
  shopId       Int?     @map("shop_id")
  content      String   @db.Text
  isAiResponse Boolean  @default(false) @map("is_ai_response")
  createdAt    DateTime @default(now()) @map("created_at")

  post   ForumPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  author User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  shop   Shop?     @relation(fields: [shopId], references: [id])

  @@index([postId])
  @@map("comments")
}

model Notification {
  id        Int              @id @default(autoincrement())
  userId    Int              @map("user_id")
  type      NotificationType
  title     String
  message   String?          @db.Text
  actionUrl String?          @map("action_url")
  isRead    Boolean          @default(false) @map("is_read")
  createdAt DateTime         @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead])
  @@index([createdAt(sort: Desc)])
  @@map("notifications")
}
